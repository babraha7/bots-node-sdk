<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>middleware/parser.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseContext.html">BaseContext</a><ul class='methods'><li data-type='method'><a href="BaseContext.html#constructMessagePayload">constructMessagePayload</a></li><li data-type='method'><a href="BaseContext.html#getLogger">getLogger</a></li><li data-type='method'><a href="BaseContext.html#getMessageModel">getMessageModel</a></li><li data-type='method'><a href="BaseContext.html#getRequest">getRequest</a></li><li data-type='method'><a href="BaseContext.html#getResponse">getResponse</a></li><li data-type='method'><a href="BaseContext.html#getVariable">getVariable</a></li><li data-type='method'><a href="BaseContext.html#setVariable">setVariable</a></li><li data-type='method'><a href="BaseContext.html#variable">variable</a></li></ul></li><li><a href="Conversation.html">CustomComponentContext</a><ul class='methods'><li data-type='method'><a href="Conversation.html#.sdkVersion">sdkVersion</a></li><li data-type='method'><a href="Conversation.html#attachment">attachment</a></li><li data-type='method'><a href="Conversation.html#botId">botId</a></li><li data-type='method'><a href="Conversation.html#channelId">channelId</a></li><li data-type='method'><a href="Conversation.html#channelType">channelType</a></li><li data-type='method'><a href="Conversation.html#constructMessagePayload">constructMessagePayload</a></li><li data-type='method'><a href="Conversation.html#error">error</a></li><li data-type='method'><a href="Conversation.html#getLogger">getLogger</a></li><li data-type='method'><a href="Conversation.html#getMessageModel">getMessageModel</a></li><li data-type='method'><a href="Conversation.html#getRequest">getRequest</a></li><li data-type='method'><a href="Conversation.html#getResponse">getResponse</a></li><li data-type='method'><a href="Conversation.html#getVariable">getVariable</a></li><li data-type='method'><a href="Conversation.html#invalidUserInput">invalidUserInput</a></li><li data-type='method'><a href="Conversation.html#keepTurn">keepTurn</a></li><li data-type='method'><a href="Conversation.html#location">location</a></li><li data-type='method'><a href="Conversation.html#logger">logger</a></li><li data-type='method'><a href="Conversation.html#MessageModel">MessageModel</a></li><li data-type='method'><a href="Conversation.html#messagePayload">messagePayload</a></li><li data-type='method'><a href="Conversation.html#nlpResult">nlpResult</a></li><li data-type='method'><a href="Conversation.html#platformVersion">platformVersion</a></li><li data-type='method'><a href="Conversation.html#postback">postback</a></li><li data-type='method'><a href="Conversation.html#properties">properties</a></li><li data-type='method'><a href="Conversation.html#rawPayload">rawPayload</a></li><li data-type='method'><a href="Conversation.html#releaseTurn">releaseTurn</a></li><li data-type='method'><a href="Conversation.html#reply">reply</a></li><li data-type='method'><a href="Conversation.html#request">request</a></li><li data-type='method'><a href="Conversation.html#sessionId">sessionId</a></li><li data-type='method'><a href="Conversation.html#setVariable">setVariable</a></li><li data-type='method'><a href="Conversation.html#text">text</a></li><li data-type='method'><a href="Conversation.html#transition">transition</a></li><li data-type='method'><a href="Conversation.html#userId">userId</a></li><li data-type='method'><a href="Conversation.html#variable">variable</a></li></ul></li><li><a href="module-Lib.EntityResolutionContext.html">EntityResolutionContext</a><ul class='methods'><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#addCandidateMessages">addCandidateMessages</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#addMessage">addMessage</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#addValidationError">addValidationError</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#clearDisambiguationValues">clearDisambiguationValues</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#clearItemValue">clearItemValue</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#constructMessagePayload">constructMessagePayload</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getCandidateMessages">getCandidateMessages</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getCurrentItem">getCurrentItem</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getCustomProperty">getCustomProperty</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getDisambiguationValues">getDisambiguationValues</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getDisplayValue">getDisplayValue</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getDisplayValues">getDisplayValues</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getEntity">getEntity</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getEntityItems">getEntityItems</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getEntityName">getEntityName</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getItemsMatched">getItemsMatched</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getItemsMatchedOutOfOrder">getItemsMatchedOutOfOrder</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getItemsUpdated">getItemsUpdated</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getItemValue">getItemValue</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getLogger">getLogger</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getMessageModel">getMessageModel</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getMessages">getMessages</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getRequest">getRequest</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getResponse">getResponse</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getUserInput">getUserInput</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getValidationErrors">getValidationErrors</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#getVariable">getVariable</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#isSkippedItem">isSkippedItem</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#setCustomProperty">setCustomProperty</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#setEntity">setEntity</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#setItemValue">setItemValue</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#setSystemEntityDisplayFunction">setSystemEntityDisplayFunction</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#setSystemEntityDisplayProperties">setSystemEntityDisplayProperties</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#setVariable">setVariable</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#skipItem">skipItem</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#unskipItem">unskipItem</a></li><li data-type='method'><a href="module-Lib.EntityResolutionContext.html#variable">variable</a></li></ul></li><li><a href="module-Lib.MessageModel.html">MessageModel</a><ul class='methods'><li data-type='method'><a href="module-Lib.MessageModel.html#.addChannelExtensions">addChannelExtensions</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.addGlobalActions">addGlobalActions</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.attachmentConversationMessage">attachmentConversationMessage</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.callActionObject">callActionObject</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.cardConversationMessage">cardConversationMessage</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.cardObject">cardObject</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.locationActionObject">locationActionObject</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.locationConversationMessage">locationConversationMessage</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.postbackActionObject">postbackActionObject</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.postbackConversationMessage">postbackConversationMessage</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.rawConversationMessage">rawConversationMessage</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.shareActionObject">shareActionObject</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.textConversationMessage">textConversationMessage</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.urlActionObject">urlActionObject</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#.validateConversationMessage">validateConversationMessage</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#isValid">isValid</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#messagePayload">messagePayload</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#rawPayload">rawPayload</a></li><li data-type='method'><a href="module-Lib.MessageModel.html#validationError">validationError</a></li></ul></li><li><a href="module-Middleware.WebhookClient.html">WebhookClient</a><ul class='methods'><li data-type='method'><a href="module-Middleware.WebhookClient.html#MessageModel">MessageModel</a></li><li data-type='method'><a href="module-Middleware.WebhookClient.html#on">on</a></li><li data-type='method'><a href="module-Middleware.WebhookClient.html#receiver">receiver</a></li><li data-type='method'><a href="module-Middleware.WebhookClient.html#send">send</a></li></ul></li><li><a href="module-Testing.MockConversation.html">MockConversation</a><ul class='methods'><li data-type='method'><a href="module-Testing.MockConversation.html#.any">any</a></li><li data-type='method'><a href="module-Testing.MockConversation.html#.fromRequest">fromRequest</a></li><li data-type='method'><a href="module-Testing.MockConversation.html#getReplies">getReplies</a></li></ul></li><li><a href="NLPResult.html">NLPResult</a><ul class='methods'><li data-type='method'><a href="NLPResult.html#entityMatches">entityMatches</a></li><li data-type='method'><a href="NLPResult.html#fullEntityMatches">fullEntityMatches</a></li><li data-type='method'><a href="NLPResult.html#intentMatches">intentMatches</a></li><li data-type='method'><a href="NLPResult.html#topIntentMatch">topIntentMatch</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-CLI.html">CLI</a></li><li><a href="module-Config.html">Config</a><ul class='methods'><li data-type='method'><a href="module-Config.html">setLogger</a></li></ul></li><li><a href="module-Lib.html">Lib</a></li><li><a href="module-Middleware.html">Middleware</a><ul class='methods'><li data-type='method'><a href="module-Middleware.html#.customComponent">customComponent</a></li><li data-type='method'><a href="module-Middleware.html#.webhookReceiver">webhookReceiver</a></li></ul></li><li><a href="module-Testing.html">Testing</a><ul class='methods'><li data-type='method'><a href="module-Testing.html#.MockCompositeBagEntityVariable">MockCompositeBagEntityVariable</a></li><li data-type='method'><a href="module-Testing.html#.MockCompositeBagItem">MockCompositeBagItem</a></li><li data-type='method'><a href="module-Testing.html#.MockEventHandlerRequest">MockEventHandlerRequest</a></li><li data-type='method'><a href="module-Testing.html#.MockRequest">MockRequest</a></li><li data-type='method'><a href="module-Testing.html#.MockResolveEntitiesEvent">MockResolveEntitiesEvent</a></li></ul></li><li><a href="module-Util.html">Util</a></li><li><a href="module-Util_MessageModel.html">Util/MessageModel</a><ul class='methods'><li data-type='method'><a href="module-Util_MessageModel.html#.cardToText">cardToText</a></li><li data-type='method'><a href="module-Util_MessageModel.html#.convertRespToText">convertRespToText</a></li></ul></li><li><a href="module-Util_Text.html">Util/Text</a><ul class='methods'><li data-type='method'><a href="module-Util_Text.html#.approxTextMatch">approxTextMatch</a></li></ul></li><li><a href="module-Util_Webhook.html">Util/Webhook</a><ul class='methods'><li data-type='method'><a href="module-Util_Webhook.html#.bodyParserRawMessageVerify">bodyParserRawMessageVerify</a></li><li data-type='method'><a href="module-Util_Webhook.html#.buildSignatureHeader">buildSignatureHeader</a></li><li data-type='method'><a href="module-Util_Webhook.html#.messageToBot">messageToBot</a></li><li data-type='method'><a href="module-Util_Webhook.html#.messageToBotWithProperties">messageToBotWithProperties</a></li><li data-type='method'><a href="module-Util_Webhook.html#.verifyMessageFormat">verifyMessageFormat</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-ExpressApplication.html">ExpressApplication</a></li><li><a href="external-ExpressRequest.html">ExpressRequest</a></li><li><a href="external-ExpressResponse.html">ExpressResponse</a></li><li><a href="external-ExpressRouter.html">ExpressRouter</a></li></ul><h3>Global</h3><ul><li><a href="global.html#init">init</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">middleware/parser.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const bodyParser = require("body-parser");
const { MiddlewareAbstract } = require("./abstract");
const { CONSTANTS } = require('../common/constants');

/**
 * Options used for express {@link https://www.npmjs.com/package/body-parser|body-parser}
 * in bots custom middleware. Options are a subset of those available in body-parser,
 * and cover most general use cases. If body-parser requirements extend beyond these
 * general options, consider using the {@link module:Util/Webhook.bodyParserRawMessageVerify}
 * function in your middleware configuration.
 * @typedef ParserOptions
 * @alias ParserOptions
 * @memberof module:Middleware
 * @property {boolean|Object} [json=true] - Parse json body payloads
 * @property {boolean|Object} [urlencoded=true] - Parse urlencoded body payloads
 * @property {string} [limit='5mb'] - Parser body size limit
 * @property {Function} [verify] - Additional body parser verification function 
 * @see {@link https://www.npmjs.com/package/body-parser}
 */

/**
 * Body parser middleware
 * @private
 */
class ParserMiddleware extends MiddlewareAbstract {
  /**
   * initialize the body-parser middleware on the application service
   * @param {external.ExpressApplication} service
   * @param {ParserOptions} options 
   */
  _init(service, options) {
    if (options.urlencoded || options.urlencoded == null) {
      this._addParser(service, bodyParser.urlencoded(this._getOptions({ extended: true }, options.urlencoded)));
    }
    if (options.json || options.json == null) {
      this._addParser(service, bodyParser.json(this._getOptions({}, options.json)));
    }
  }

  /**
   * add/replace parser to the application or router stack.
   * @param {external.ExpressApplication} service 
   * @param {function} parser - body parser middleware
   */
  _addParser(service, parser) {
    let stack = (service &amp;&amp; (service['_router'] || service).stack) || [];
    let replaced = false;

    // find/replace in stack
    stack.filter(layer => layer.name === parser.name)
      .forEach(layer => {
        replaced = true;
        layer.handle = parser;
      });

    // add to stack if not already replaced
    if (!replaced) {
      service.use(parser);
    }
  }

  /**
   * get common options object
   */
  _commonOptions() {
    const { limit, verify } = this.options;
    return {
      limit: limit || '5mb',
      verify: (req, res, buf, encoding) => {
        // Instead of just letting bodyParser.json to parse the raw message to JSON, the rawMessage and its encoding is saved as properties
        // 'rawBody' and 'encoding' for use in signature verification in method verifyMessageFormat.
        req[CONSTANTS.PARSER_RAW_BODY] = buf;
        req[CONSTANTS.PARSER_RAW_ENCODING] = encoding;
        return verify ? verify(req, res, buf, encoding) : true;
      }
    }
  }

  /**
   * get final parser options by combining defaults with user-defined opts
   * @param {object} defaults - parser default options
   * @param {*} opts - user defined options
   */
  _getOptions(defaults, opts) {
    opts = typeof opts === 'object' ? opts : {};
    return Object.assign(defaults, opts, this._commonOptions());
  }
}

module.exports = {
  ParserMiddleware,
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
